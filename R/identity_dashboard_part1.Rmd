---
title: "Identity Threat Dynamics: Intelligence Dashboard"
output: 
  flexdashboard::flex_dashboard:
    theme: 
      version: 4
      bg: "#0a0e27"
      fg: "#e0e7ff"
      primary: "#6366f1"
      base_font: 
        google: "Inter"
      code_font:
        google: "Fira Code"
    orientation: columns
    vertical_layout: scroll
    social: menu
    source_code: embed
runtime: shiny
---

```{r setup, include=FALSE}
# Load required packages
library(flexdashboard)
library(tidyverse)
library(plotly)
library(DT)
library(lubridate)
library(slider)
library(shiny)

# Source analysis scripts
source("R/data_generation.R", local = TRUE)
source("R/forecasting_models.R", local = TRUE)
source("R/anomaly_detection.R", local = TRUE)
source("R/bayesian_model.R", local = TRUE)

# Set theme
theme_set(theme_minimal(base_size = 12))

# Custom color palette (indigo/violet/periwinkle)
colors_main <- c("#6366f1", "#8b5cf6", "#a78bfa", "#c4b5fd")
colors_groups <- c("Group_A" = "#6366f1", "Group_B" = "#8b5cf6")

# Load or generate data
if (file.exists("data/identity_threat_data.rds")) {
  data <- readRDS("data/identity_threat_data.rds")
} else {
  cat("Generating data...\n")
  source("R/data_generation.R")
  data <- readRDS("data/identity_threat_data.rds")
}

# Run analyses
cat("Running anomaly detection...\n")
data <- detect_isolation_forest(data)
data <- detect_all_spikes(data)

cat("Simulating belief trajectories...\n")
belief_trajectories <- simulate_all_belief_trajectories(data)

cat("Calculating forecasts...\n")
# Forecast for both groups (limited to prevent dashboard slowdown)
forecast_vars <- c("emotional_rhetoric_score", "identity_threat_index", 
                  "perceived_credibility_score")

forecasts_a <- forecast_group_variables(data, "Group_A", forecast_vars, horizon = 90)
forecasts_b <- forecast_group_variables(data, "Group_B", forecast_vars, horizon = 90)

cat("Dashboard preparation complete.\n")
```

```{css}
/* Custom CSS for research aesthetic */
.chart-title {
  color: #a5b4fc;
  font-weight: 600;
  font-size: 16px;
  margin-bottom: 10px;
}

.value-box {
  background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
  border: 1px solid #6366f1;
}

.metric-card {
  background: #0f172a;
  border: 1px solid #3730a3;
  border-radius: 8px;
  padding: 15px;
  margin: 10px 0;
}
```

System Overview {data-icon="fa-chart-line"}
=====================================

Column {data-width=650}
-----------------------------------------------------------------------

### Multi-Dimensional Time Series

```{r}
# Prepare data for multi-line plot
plot_data <- data %>%
  select(date, group, identity_threat_index, emotional_rhetoric_score, 
         media_intensity_index, perceived_credibility_score) %>%
  pivot_longer(cols = c(identity_threat_index, emotional_rhetoric_score,
                       media_intensity_index, perceived_credibility_score),
               names_to = "metric", values_to = "value") %>%
  mutate(metric = str_to_title(str_replace_all(metric, "_", " ")))

plot_ly(plot_data, x = ~date, y = ~value, color = ~metric, 
        type = 'scatter', mode = 'lines',
        line = list(width = 1.5),
        colors = c("#6366f1", "#8b5cf6", "#a78bfa", "#c4b5fd")) %>%
  layout(
    title = list(text = "System Dynamics Overview", 
                font = list(color = "#a5b4fc", size = 18)),
    xaxis = list(title = "Date", gridcolor = "#1e293b", color = "#94a3b8"),
    yaxis = list(title = "Score (0-100)", gridcolor = "#1e293b", color = "#94a3b8"),
    paper_bgcolor = "#0a0e27",
    plot_bgcolor = "#0f172a",
    legend = list(font = list(color = "#cbd5e1")),
    hovermode = "x unified"
  )
```

### Cross-Correlation Analysis

```{r}
# Calculate cross-correlations
ccf_data <- data %>%
  filter(group == "Group_A") %>%
  select(identity_threat_index, emotional_rhetoric_score) %>%
  na.omit()

ccf_result <- ccf(ccf_data$identity_threat_index, 
                 ccf_data$emotional_rhetoric_score,
                 lag.max = 30, plot = FALSE)

ccf_df <- tibble(
  lag = ccf_result$lag,
  correlation = ccf_result$acf
)

plot_ly(ccf_df, x = ~lag, y = ~correlation, type = 'bar',
       marker = list(color = '#6366f1')) %>%
  layout(
    title = list(text = "Threat → Rhetoric Cross-Correlation (Group A)", 
                font = list(color = "#a5b4fc", size = 16)),
    xaxis = list(title = "Lag (days)", gridcolor = "#1e293b", color = "#94a3b8"),
    yaxis = list(title = "Correlation", gridcolor = "#1e293b", color = "#94a3b8"),
    paper_bgcolor = "#0a0e27",
    plot_bgcolor = "#0f172a"
  )
```

Column {data-width=350}
-----------------------------------------------------------------------

### Key Metrics

```{r}
# Calculate summary statistics
current_date <- max(data$date)
recent_data <- data %>% filter(date >= current_date - days(30))

metrics <- recent_data %>%
  group_by(group) %>%
  summarise(
    avg_threat = mean(identity_threat_index, na.rm = TRUE),
    avg_rhetoric = mean(emotional_rhetoric_score, na.rm = TRUE),
    avg_credibility = mean(perceived_credibility_score, na.rm = TRUE),
    stability = mean(narrative_stability_index, na.rm = TRUE)
  )

DT::datatable(
  metrics,
  options = list(
    dom = 't',
    pageLength = 10,
    initComplete = JS(
      "function(settings, json) {",
      "$(this.api().table().container()).css({'background-color': '#0f172a', 'color': '#cbd5e1'});",
      "}"
    )
  ),
  rownames = FALSE,
  class = 'cell-border stripe',
  colnames = c("Group", "Avg Threat", "Avg Rhetoric", "Avg Credibility", "Stability")
) %>%
  formatRound(columns = 2:5, digits = 1)
```

### System Health Indicators

```{r}
# Overall system metrics
system_metrics <- data %>%
  summarise(
    `Total Observations` = n(),
    `Date Range` = paste(min(date), "to", max(date)),
    `Average Threat Level` = round(mean(identity_threat_index, na.rm = TRUE), 1),
    `Rhetoric Escalation` = round(mean(emotional_rhetoric_score, na.rm = TRUE), 1),
    `Anomalies Detected` = sum(iso_anomaly_flag, na.rm = TRUE),
    `Spike Events` = sum(any_spike, na.rm = TRUE)
  ) %>%
  pivot_longer(everything(), names_to = "Metric", values_to = "Value")

DT::datatable(
  system_metrics,
  options = list(
    dom = 't',
    pageLength = 10,
    initComplete = JS(
      "function(settings, json) {",
      "$(this.api().table().container()).css({'background-color': '#0f172a', 'color': '#cbd5e1'});",
      "}"
    )
  ),
  rownames = FALSE
)
```

### Data Quality

```{r}
# Data completeness metrics
completeness <- data %>%
  summarise(across(where(is.numeric), ~sum(!is.na(.x)) / n() * 100)) %>%
  pivot_longer(everything(), names_to = "Variable", values_to = "Completeness %") %>%
  arrange(desc(`Completeness %`))

plot_ly(completeness, x = ~`Completeness %`, y = ~Variable, type = 'bar',
       orientation = 'h', marker = list(color = '#8b5cf6')) %>%
  layout(
    title = list(text = "Data Completeness", 
                font = list(color = "#a5b4fc", size = 14)),
    xaxis = list(title = "Completeness (%)", gridcolor = "#1e293b", color = "#94a3b8"),
    yaxis = list(title = "", gridcolor = "#1e293b", color = "#94a3b8"),
    paper_bgcolor = "#0a0e27",
    plot_bgcolor = "#0f172a"
  )
```


Identity Threat Dynamics {data-icon="fa-exclamation-triangle"}
=====================================

Column {data-width=600}
-----------------------------------------------------------------------

### Identity Threat Index by Group

```{r}
# Rolling average for smoothing
threat_plot_data <- data %>%
  arrange(date, group) %>%
  group_by(group) %>%
  mutate(
    threat_7day = slider::slide_dbl(identity_threat_index, mean, 
                                    .before = 6, .complete = FALSE),
    threat_30day = slider::slide_dbl(identity_threat_index, mean,
                                     .before = 29, .complete = FALSE)
  )

plot_ly(threat_plot_data) %>%
  add_trace(x = ~date, y = ~identity_threat_index, color = ~group,
           type = 'scatter', mode = 'lines', opacity = 0.3,
           line = list(width = 1),
           colors = colors_groups,
           name = ~paste(group, "(Daily)")) %>%
  add_trace(x = ~date, y = ~threat_7day, color = ~group,
           type = 'scatter', mode = 'lines',
           line = list(width = 2),
           colors = colors_groups,
           name = ~paste(group, "(7-day avg)")) %>%
  layout(
    title = list(text = "Identity Threat Trajectories with Rolling Averages", 
                font = list(color = "#a5b4fc", size = 18)),
    xaxis = list(title = "Date", gridcolor = "#1e293b", color = "#94a3b8"),
    yaxis = list(title = "Threat Index (0-100)", gridcolor = "#1e293b", color = "#94a3b8"),
    paper_bgcolor = "#0a0e27",
    plot_bgcolor = "#0f172a",
    legend = list(font = list(color = "#cbd5e1")),
    hovermode = "x unified"
  )
```

### Threat Divergence Over Time

```{r}
# Calculate divergence
divergence_data <- data %>%
  select(date, group, identity_threat_index) %>%
  pivot_wider(names_from = group, values_from = identity_threat_index) %>%
  mutate(divergence = abs(Group_A - Group_B))

plot_ly(divergence_data, x = ~date, y = ~divergence, type = 'scatter', 
       mode = 'lines', fill = 'tozeroy',
       line = list(color = '#a78bfa', width = 2),
       fillcolor = 'rgba(167, 139, 250, 0.2)') %>%
  layout(
    title = list(text = "Threat Perception Divergence Between Groups", 
                font = list(color = "#a5b4fc", size = 16)),
    xaxis = list(title = "Date", gridcolor = "#1e293b", color = "#94a3b8"),
    yaxis = list(title = "Absolute Divergence", gridcolor = "#1e293b", color = "#94a3b8"),
    paper_bgcolor = "#0a0e27",
    plot_bgcolor = "#0f172a"
  )
```

Column {data-width=400}
-----------------------------------------------------------------------

### Threat Distribution by Group

```{r}
plot_ly(data, x = ~identity_threat_index, color = ~group, type = "histogram",
       opacity = 0.7, colors = colors_groups) %>%
  layout(
    title = list(text = "Threat Index Distribution", 
                font = list(color = "#a5b4fc", size = 16)),
    xaxis = list(title = "Threat Index", gridcolor = "#1e293b", color = "#94a3b8"),
    yaxis = list(title = "Frequency", gridcolor = "#1e293b", color = "#94a3b8"),
    paper_bgcolor = "#0a0e27",
    plot_bgcolor = "#0f172a",
    barmode = "overlay",
    legend = list(font = list(color = "#cbd5e1"))
  )
```

### Threat vs Media Correlation

```{r}
plot_ly(data, x = ~media_intensity_index, y = ~identity_threat_index, 
       color = ~group, type = 'scatter', mode = 'markers',
       marker = list(size = 3, opacity = 0.5),
       colors = colors_groups) %>%
  layout(
    title = list(text = "Media Intensity vs Identity Threat", 
                font = list(color = "#a5b4fc", size = 16)),
    xaxis = list(title = "Media Intensity", gridcolor = "#1e293b", color = "#94a3b8"),
    yaxis = list(title = "Threat Index", gridcolor = "#1e293b", color = "#94a3b8"),
    paper_bgcolor = "#0a0e27",
    plot_bgcolor = "#0f172a",
    legend = list(font = list(color = "#cbd5e1"))
  )
```

### Group Convergence Analysis

```{r}
# Calculate convergence metric (decreasing divergence = convergence)
convergence_analysis <- threat_plot_data %>%
  select(date, group, threat_30day) %>%
  pivot_wider(names_from = group, values_from = threat_30day) %>%
  mutate(
    divergence = abs(Group_A - Group_B),
    period = case_when(
      date < min(date) + months(8) ~ "Early (0-8 months)",
      date < min(date) + months(16) ~ "Middle (8-16 months)",
      TRUE ~ "Late (16-24 months)"
    )
  ) %>%
  group_by(period) %>%
  summarise(avg_divergence = mean(divergence, na.rm = TRUE)) %>%
  na.omit()

plot_ly(convergence_analysis, x = ~period, y = ~avg_divergence, type = 'bar',
       marker = list(color = c('#6366f1', '#8b5cf6', '#a78bfa'))) %>%
  layout(
    title = list(text = "Threat Convergence by Period", 
                font = list(color = "#a5b4fc", size = 16)),
    xaxis = list(title = "", gridcolor = "#1e293b", color = "#94a3b8"),
    yaxis = list(title = "Avg Divergence", gridcolor = "#1e293b", color = "#94a3b8"),
    paper_bgcolor = "#0a0e27",
    plot_bgcolor = "#0f172a"
  )
```


Institutional Response {data-icon="fa-building"}
=====================================

Column {data-width=650}
-----------------------------------------------------------------------

### Institutional Response Speed and Narrative Stability

```{r}
inst_plot_data <- data %>%
  select(date, group, institutional_response_speed, narrative_stability_index) %>%
  pivot_longer(cols = c(institutional_response_speed, narrative_stability_index),
               names_to = "metric", values_to = "value") %>%
  mutate(metric = case_when(
    metric == "institutional_response_speed" ~ "Institutional Response",
    metric == "narrative_stability_index" ~ "Narrative Stability"
  ))

plot_ly(inst_plot_data, x = ~date, y = ~value, color = ~metric,
       linetype = ~group, type = 'scatter', mode = 'lines',
       line = list(width = 1.5),
       colors = c("#6366f1", "#a78bfa")) %>%
  layout(
    title = list(text = "Institutional Response Effects on Narrative Stability", 
                font = list(color = "#a5b4fc", size = 18)),
    xaxis = list(title = "Date", gridcolor = "#1e293b", color = "#94a3b8"),
    yaxis = list(title = "Score (0-100)", gridcolor = "#1e293b", color = "#94a3b8"),
    paper_bgcolor = "#0a0e27",
    plot_bgcolor = "#0f172a",
    legend = list(font = list(color = "#cbd5e1")),
    hovermode = "x unified"
  )
```

### Lagged Correlation: Response Speed → Stability

```{r}
# Calculate lagged correlations
lag_analysis <- data %>%
  filter(group == "Group_A") %>%
  arrange(date)

lags <- 0:21
correlations <- map_dbl(lags, ~{
  if (.x == 0) {
    cor(lag_analysis$institutional_response_speed,
        lag_analysis$narrative_stability_index,
        use = "complete.obs")
  } else {
    cor(lag(lag_analysis$institutional_response_speed, .x),
        lag_analysis$narrative_stability_index,
        use = "complete.obs")
  }
})

lag_df <- tibble(lag_days = lags, correlation = correlations)

plot_ly(lag_df, x = ~lag_days, y = ~correlation, type = 'scatter',
       mode = 'lines+markers',
       line = list(color = '#6366f1', width = 2),
       marker = list(color = '#8b5cf6', size = 8)) %>%
  layout(
    title = list(text = "Lagged Effect of Institutional Response on Stability", 
                font = list(color = "#a5b4fc", size = 16)),
    xaxis = list(title = "Lag (days)", gridcolor = "#1e293b", color = "#94a3b8"),
    yaxis = list(title = "Correlation", gridcolor = "#1e293b", color = "#94a3b8"),
    paper_bgcolor = "#0a0e27",
    plot_bgcolor = "#0f172a"
  )
```

Column {data-width=350}
-----------------------------------------------------------------------

### Response Effectiveness Regression

```{r}
# Regression model
model_data <- data %>%
  filter(!is.na(institutional_response_speed) & !is.na(narrative_stability_index))

model <- lm(narrative_stability_index ~ institutional_response_speed + group, 
           data = model_data)

# Extract coefficients
coef_df <- broom::tidy(model) %>%
  mutate(term = case_when(
    term == "(Intercept)" ~ "Intercept",
    term == "institutional_response_speed" ~ "Response Speed",
    term == "groupGroup_B" ~ "Group B Effect"
  ))

DT::datatable(
  coef_df,
  options = list(
    dom = 't',
    pageLength = 10,
    initComplete = JS(
      "function(settings, json) {",
      "$(this.api().table().container()).css({'background-color': '#0f172a', 'color': '#cbd5e1'});",
      "}"
    )
  ),
  rownames = FALSE,
  colnames = c("Term", "Estimate", "Std Error", "t-value", "p-value")
) %>%
  formatRound(columns = 2:5, digits = 3) %>%
  formatStyle(
    'p.value',
    backgroundColor = styleInterval(0.05, c('#064e3b', '#0f172a'))
  )
```

### Model Summary

```{r}
# Model fit statistics
model_summary <- broom::glance(model) %>%
  select(r.squared, adj.r.squared, sigma, statistic, p.value) %>%
  pivot_longer(everything(), names_to = "Statistic", values_to = "Value")

DT::datatable(
  model_summary,
  options = list(
    dom = 't',
    pageLength = 10,
    initComplete = JS(
      "function(settings, json) {",
      "$(this.api().table().container()).css({'background-color': '#0f172a', 'color': '#cbd5e1'});",
      "}"
    )
  ),
  rownames = FALSE
) %>%
  formatRound(columns = 2, digits = 4)
```

### Response Time Distribution

```{r}
plot_ly(data, y = ~institutional_response_speed, color = ~group, type = "box",
       colors = colors_groups) %>%
  layout(
    title = list(text = "Response Speed Distribution by Group", 
                font = list(color = "#a5b4fc", size = 14)),
    yaxis = list(title = "Response Speed", gridcolor = "#1e293b", color = "#94a3b8"),
    paper_bgcolor = "#0a0e27",
    plot_bgcolor = "#0f172a",
    showlegend = FALSE
  )
```


Credibility Signaling {data-icon="fa-shield-alt"}
=====================================

Column {.tabset}
-----------------------------------------------------------------------

### Evidence vs Credibility Decoupling

```{r}
plot_ly(data, x = ~evidence_strength, y = ~perceived_credibility_score,
       color = ~group, type = 'scatter', mode = 'markers',
       marker = list(size = 4, opacity = 0.4),
       colors = colors_groups) %>%
  add_lines(x = c(0, 100), y = c(0, 100), 
           line = list(color = 'rgba(255,255,255,0.3)', dash = 'dash'),
           showlegend = FALSE, hoverinfo = 'skip') %>%
  layout(
    title = list(text = "Evidence-Credibility Decoupling Analysis", 
                font = list(color = "#a5b4fc", size = 18)),
    xaxis = list(title = "Evidence Strength (Objective)", gridcolor = "#1e293b", color = "#94a3b8"),
    yaxis = list(title = "Perceived Credibility (Subjective)", gridcolor = "#1e293b", color = "#94a3b8"),
    paper_bgcolor = "#0a0e27",
    plot_bgcolor = "#0f172a",
    legend = list(font = list(color = "#cbd5e1")),
    annotations = list(
      x = 50, y = 90,
      text = "Dashed line = Perfect correlation",
      showarrow = FALSE,
      font = list(color = "#94a3b8", size = 10)
    )
  )
```

### Institutional Amplification Effect

```{r}
# Institutional response as credibility multiplier
inst_effect_data <- data %>%
  mutate(
    inst_tercile = ntile(institutional_response_speed, 3),
    inst_group = case_when(
      inst_tercile == 1 ~ "Low Response",
      inst_tercile == 2 ~ "Medium Response",
      inst_tercile == 3 ~ "High Response"
    )
  )

plot_ly(inst_effect_data, x = ~evidence_strength, y = ~perceived_credibility_score,
       color = ~inst_group, type = 'scatter', mode = 'markers',
       marker = list(size = 4, opacity = 0.5),
       colors = c('#dc2626', '#f59e0b', '#10b981')) %>%
  layout(
    title = list(text = "How Institutional Signals Amplify Perceived Credibility", 
                font = list(color = "#a5b4fc", size = 18)),
    xaxis = list(title = "Evidence Strength", gridcolor = "#1e293b", color = "#94a3b8"),
    yaxis = list(title = "Perceived Credibility", gridcolor = "#1e293b", color = "#94a3b8"),
    paper_bgcolor = "#0a0e27",
    plot_bgcolor = "#0f172a",
    legend = list(title = list(text = "Institutional Response"), 
                 font = list(color = "#cbd5e1"))
  )
```

### Credibility Path Analysis

```{r}
# Show credibility trajectory with evidence overlay
cred_path <- data %>%
  select(date, group, perceived_credibility_score, evidence_strength) %>%
  arrange(date, group)

plot_ly(cred_path) %>%
  add_trace(x = ~date, y = ~perceived_credibility_score, color = ~group,
           type = 'scatter', mode = 'lines', name = "Perceived Credibility",
           line = list(width = 2),
           colors = colors_groups) %>%
  add_trace(x = ~date, y = ~evidence_strength, color = ~group,
           type = 'scatter', mode = 'lines', name = "Evidence Strength",
           line = list(width = 1, dash = 'dot'),
           colors = colors_groups,
           opacity = 0.5) %>%
  layout(
    title = list(text = "Credibility vs Evidence Trajectories", 
                font = list(color = "#a5b4fc", size = 18)),
    xaxis = list(title = "Date", gridcolor = "#1e293b", color = "#94a3b8"),
    yaxis = list(title = "Score (0-100)", gridcolor = "#1e293b", color = "#94a3b8"),
    paper_bgcolor = "#0a0e27",
    plot_bgcolor = "#0f172a",
    legend = list(font = list(color = "#cbd5e1")),
    hovermode = "x unified"
  )
```
